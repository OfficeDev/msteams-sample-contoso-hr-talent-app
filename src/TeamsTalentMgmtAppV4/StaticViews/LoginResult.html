<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>Contoso - Login Result</title>
    <script type="text/javascript" src="https://alcdn.msauth.net/browser/2.16.1/js/msal-browser.js"></script>
    <script src="https://statics.teams.microsoft.com/sdk/v1.5.2/js/MicrosoftTeams.min.js" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>
    <!--<script src="https://unpkg.com/@microsoft/teams-js@1.5.0/dist/MicrosoftTeams.min.js" integrity="sha384-EKT9Wswdn78EAHAqcOh50wnaPfH3aPa7YZ1R89/TCN98AhkqZJ2g47u4k2I5eCk8" crossorigin="anonymous"></script>
    <script src="https://secure.aadcdn.microsoftonline-p.com/lib/1.0.17/js/adal.min.js" integrity="sha384-BIOS/65fbAsb2XiCCSTlZSTTl0ZgqkOU522dpyk5meOnN2EOQ3uH+QpqEtoAtmBn" crossorigin="anonymous"></script>-->

    <style rel="stylesheet">
        [lang|=en], body {
            font-family: Arial,sans-serif;
        }

        [lang|=ja] {
            font-family: Hiragino Kaku Gothic Pro,ヒラギノ角ゴ Pro W3,メイリオ,Meiryo,ＭＳ\ Ｐゴシック,Verdana,Arial,sans-serif;
        }

        body {
            background: #f5f5f5;
            color: #333;
        }

        h2 {
            color: #000000;
        }

        h2, p {
            margin: 10px 0 0 0;
        }

        .panel {
            margin: 20px 112px;
        }

        #content {
            padding: 40px;
            text-align: center;
            color: #707070;
            background: #ffffff;
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <div class="panel">
        <div id="content">
            Processing...
        </div>
    </div>

    <script type="text/javascript">

        //todojack: improve this page....

        //this is where the user will land once they have done an Azure AD sign-in, if the fallback method for SSO is used

        initialiseTeams = () => {
            let rejectPromise = null;
            let timeout = null;

            const promise = new Promise((resolve, reject) => {
                rejectPromise = reject;
                microsoftTeams.initialize(() => {
                    window.clearTimeout(timeout);
                    resolve(true);
                }
                )
            });
            //todo: try and improve this if possible. At present this function will return that the page is not open in Teams
            //based on the MicrosoftTeams.initialize function timing out within 2 seconds

            timeout = window.setTimeout(() => {
                rejectPromise("Teams Initialise Timeout");
            }, 2000);

            return promise;
        }


        //similar to Auth-Start options/parameters, but we need to define navigateToLoginRequestUrl: false or it sends us back to Auth-Start, which we do not want in this sample app.
        const msalConfig = {
            auth: {
                clientId: "253f51df-b6b5-4792-8347-90883f76a10a",
                redirectUri: location.protocol + "//" + location.hostname + ":" + location.port + "/StaticViews/LoginResult.html",
                navigateToLoginRequestUrl: false
            }
        };

        //MSAL ClientApp is initalized with msalConfig options
        const clientApp = new msal.PublicClientApplication(msalConfig);

        //this function handles the RedirectPromise and provides us with an Access Token


        handlePageLoad = async () => {

            clientApp.handleRedirectPromise().then((response) => {
                window.localStorage.setItem("userToken", response.accessToken);
                passToken();

            })};

        passToken = async (response) => {
            try {

                await this.initialiseTeams();
                this.inTeams = true;
            }
            catch {
                this.inTeams = false;
            }

            if (this.inTeams) {

                //todojack: write if statement for teams, vs website...

                microsoftTeams.authentication.notifySuccess({ idToken: response.idToken, accessToken: response.accessToken, tokenType: response.tokenType, expiresIn: response.expiresIn });
            }
            else {
                //todojack: check scott's sample to see how to handle SSO outside of Teams
                let redirectURL = window.localStorage.getItem("sourceHostname");
                window.localStorage.removeItem("sourceHostname");
                window.location.assign(redirectURL);
            }
        };

        $(this.handlePageLoad);



        //end of improvements

        //microsoftTeams.initialize(function () {
        //    var clientId = getLocalStorageData('userClientId');

        //    if (!clientId) {
        //        displayError();
        //    }
        //    else {
        //        var config = {
        //            redirectUri: "https://" + window.location.host + "/StaticViews/LoginResult.html",
        //            cacheLocation: "localStorage",
        //            navigateToLoginRequestUrl: false,
        //            clientId: clientId
        //        };

        //        var authContext = new AuthenticationContext(config);

        //        if (authContext.isCallback(window.location.hash)) {
        //            authContext.handleWindowCallback(window.location.hash);
        //        }

        //        var user = authContext.getCachedUser();
        //        if (!user) {
        //            displayError();
        //        }
        //        else {
        //            displaySuccess(user.userName);
        //        }
        //    }
        //});

        //function getLocalStorageData(key) {
        //    var result = window.localStorage.getItem(key);
        //    if (!result && window.opener) {
        //        result = window.opener.localStorage.getItem(key);
        //        window.localStorage.setItem(key, result);
        //    }

        //    return result;
        //}

        //function displaySuccess(userName) {
        //    document.getElementById('content')
        //        .innerHTML =
        //        '<h2>Authentication Successful</h2>' +
        //        '<p>Microsoft Teams has been successfully authenticated. You may now close this page.</p>';

        //    try {
        //        microsoftTeams.authentication.notifySuccess(userName);
        //    } catch (e) {
        //        console.log('LoginResult::Notify success error: ', e);
        //    }
        //}

        //function displayError() {
        //    var error = localStorage.getItem('adal.login.error') || localStorage.getItem('adal.error');

        //    document.getElementById('content')
        //        .innerHTML =
        //        '<h2>' + (error || 'Error occured') + '</h2>' +
        //        '<p>' + (localStorage.getItem('adal.error.description') || 'Error while authorization') + '</p>';

        //    window.onbeforeunload = function () {
        //        if (error) {
        //            microsoftTeams.authentication.notifyFailure(error);
        //        }
        //    }
        //}
    </script>
</body>
</html>
